---
import { Image } from "astro:assets";
import { cn, getOptimizedImageUrl } from "../lib/utils";
import type { Tour } from "../data/tours";

interface Props {
  tour: Tour;
}

const { tour } = Astro.props;
const minPrice =
  tour.variants.length > 0
    ? Math.min(...tour.variants.map((v) => v.price.rack))
    : 0;

// Resolve local images from src/assets
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/images/**/*.{jpeg,jpg,png,tiff,webp,gif,svg,avif}",
);
let localImage;
if (!tour.image.startsWith("http")) {
  // Convert public path to asset path
  const assetPath = tour.image.startsWith("/images")
    ? `/src/assets${tour.image}`
    : `/src/assets/images/${tour.image}`;

  if (images[assetPath]) {
    localImage = images[assetPath]();
  }
}

// Helper to render TripAdvisor-style bubbles
const rating = tour.rating || 5;
---

<div class="scroll-reveal-card">
  <a
    href={`/tours/${tour.slug}`}
    class="group relative flex flex-col h-full bg-white rounded-[2rem] border border-slate-100 shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] hover:shadow-[0_20px_40px_-12px_rgba(0,0,0,0.1)] transition-all duration-500 overflow-hidden"
  >
    {/* Image Section */}
    <div class="relative aspect-[16/10] overflow-hidden flex-shrink-0">
      {
        localImage ? (
          <Image
            src={localImage}
            alt={tour.title}
            width={800}
            height={500}
            class="w-full h-full object-cover transition-transform duration-[2s] ease-out group-hover:scale-105"
            loading="lazy"
            decoding="async"
          />
        ) : (
          <img
            src={getOptimizedImageUrl(tour.image, 800)}
            srcset={
              tour.image.startsWith("http")
                ? `${getOptimizedImageUrl(tour.image, 400)} 400w, ${getOptimizedImageUrl(tour.image, 800)} 800w`
                : undefined
            }
            sizes={
              tour.image.startsWith("http")
                ? "(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 400px"
                : undefined
            }
            alt={tour.title}
            loading="lazy"
            decoding="async"
            class="w-full h-full object-cover transition-transform duration-[2s] ease-out group-hover:scale-105"
          />
        )
      }

      {/* Minimalist Multi-Badge */}
      <div class="absolute top-4 left-4 flex flex-col gap-2">
        <div
          class="bg-white/90 backdrop-blur-md text-slate-900 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-sm"
        >
          {tour.category}
        </div>
        {
          tour.id === "combo-001" && (
            <div class="bg-[var(--color-primary)] text-white px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-sm animate-pulse">
              Selling Fast
            </div>
          )
        }
        {
          tour.category === "Wildlife" && (
            <div class="bg-amber-400 text-slate-900 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-sm">
              Small Groups
            </div>
          )
        }
      </div>
    </div>

    {/* Content Section */}
    <div class="p-5 sm:p-8 flex flex-col flex-1">
      {/* Top Row: TripAdvisor Integration */}
      <div class="flex items-center gap-3 mb-4">
        <div class="w-4 h-4 text-emerald-600">
          <svg
            viewBox="0 -96 512.2 512.2"
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
          >
            <path
              d="M128.2 127.9C92.7 127.9 64 156.6 64 192c0 35.4 28.7 64.1 64.1 64.1 35.4 0 64.1-28.7 64.1-64.1.1-35.4-28.6-64.1-64-64.1zm0 110c-25.3 0-45.9-20.5-45.9-45.9s20.5-45.9 45.9-45.9S174 166.7 174 192s-20.5 45.9-45.8 45.9z"
            ></path><circle cx="128.4" cy="191.9" r="31.9"></circle><path
              d="M384.2 127.9c-35.4 0-64.1 28.7-64.1 64.1 0 35.4 28.7 64.1 64.1 64.1 35.4 0 64.1-28.7 64.1-64.1 0-35.4-28.7-64.1-64.1-64.1zm0 110c-25.3 0-45.9-20.5-45.9-45.9s20.5-45.9 45.9-45.9S430 166.7 430 192s-20.5 45.9-45.8 45.9z"
            ></path><circle cx="384.4" cy="191.9" r="31.9"></circle><path
              d="M474.4 101.2l37.7-37.4h-76.4C392.9 29 321.8 0 255.9 0c-66 0-136.5 29-179.3 63.8H0l37.7 37.4C14.4 124.4 0 156.5 0 192c0 70.8 57.4 128.2 128.2 128.2 32.5 0 62.2-12.1 84.8-32.1l43.4 31.9 42.9-31.2-.5-1.2c22.7 20.2 52.5 32.5 85.3 32.5 70.8 0 128.2-57.4 128.2-128.2-.1-35.4-14.6-67.5-37.9-90.7zM368 64.8c-60.7 7.6-108.3 57.6-111.9 119.5-3.7-62-51.4-112.1-112.3-119.5 30.6-22 69.6-32.8 112.1-32.8S337.4 42.8 368 64.8zM128.2 288.2C75 288.2 32 245.1 32 192s43.1-96.2 96.2-96.2 96.2 43.1 96.2 96.2c-.1 53.1-43.1 96.2-96.2 96.2zm256 0c-53.1 0-96.2-43.1-96.2-96.2s43.1-96.2 96.2-96.2 96.2 43.1 96.2 96.2c-.1 53.1-43.1 96.2-96.2 96.2z"
            ></path></svg
          >
        </div>
        <div class="flex gap-[2px] items-center">
          {
            Array.from({ length: 5 }).map((_, i) => {
              const filled = i < Math.floor(rating);
              const half = !filled && i < rating;
              return (
                <div
                  class={cn(
                    "w-2.5 h-2.5 rounded-full border border-emerald-500",
                    filled
                      ? "bg-emerald-500"
                      : half
                        ? "bg-gradient-to-r from-emerald-500 from-50% to-transparent to-50%"
                        : "bg-transparent",
                  )}
                />
              );
            })
          }
        </div>
        <span
          class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
          aria-label={`${tour.reviewsCount || 0} reviews on TripAdvisor`}
        >
          {tour.reviewsCount || 0} reviews
        </span>
      </div>

      <h3
        class="text-xl font-bold leading-tight text-slate-900 mb-3 group-hover:text-[var(--color-primary)] transition-colors duration-300 line-clamp-2"
      >
        {tour.title}
      </h3>

      <p class="text-slate-500 text-xs leading-relaxed line-clamp-3 mb-6">
        {tour.shortDescription || tour.description}
      </p>

      <div
        class="flex items-center justify-between mt-auto pt-6 border-t border-slate-50"
      >
        <div class="flex flex-col">
          <span
            class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1"
            >Duration</span
          >
          <div
            class="flex items-center gap-1.5 text-slate-700 font-bold text-xs"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="text-slate-400"
              ><circle cx="12" cy="12" r="10"></circle><polyline
                points="12 6 12 12 16 14"></polyline></svg
            >
            {tour.duration}
          </div>
        </div>

        <div class="flex flex-col items-end">
          <span
            class="text-[9px] font-black text-[var(--color-primary)] uppercase tracking-widest mb-1"
            >From only</span
          >
          <div
            class="text-xl font-black text-slate-900 leading-none flex items-start"
          >
            <span class="text-[10px] mt-1 mr-0.5 opacity-40">$</span>
            {minPrice}
          </div>
        </div>
      </div>
    </div>
  </a>
</div>

<style>
  .scroll-reveal-card {
    opacity: 0;
    transform: translateY(20px);
    transition:
      opacity 0.6s ease-out,
      transform 0.6s ease-out;
  }

  :global(.is-visible) .scroll-reveal-card {
    opacity: 1;
    transform: translateY(0);
  }

  .vertical-text {
    writing-mode: vertical-rl;
  }
</style>
